# **–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ ‚Ññ20**

üîñ–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –¥–ª—è –∫—É—Ä—Å–∞ [Administrator Linux.Professional](https://otus.ru/lessons/linux-professional/)

## **–°—Ü–µ–Ω–∞—Ä–∏–∏ iptables**
 
–¶–µ–ª—å:

- —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å knocking port;
- centralRouter –º–æ–∂–µ—Ç –ø–æ–ø–∞—Å—Ç—å –Ω–∞ ssh inetrRouter —á–µ—Ä–µ–∑ knock —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏–º–µ—Ä –≤ –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö;
- –¥–æ–±–∞–≤–∏—Ç—å inetRouter2, –∫–æ—Ç–æ—Ä—ã–π –≤–∏–¥–µ–Ω (–º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç—Å—è (host-only —Ç–∏–ø —Å–µ—Ç–∏ –¥–ª—è –≤–∏—Ä—Ç—É–∞–ª–∫–∏)) —Å —Ö–æ—Å—Ç–∞ –∏–ª–∏ —Ñ–æ—Ä–≤–∞—Ä–¥–∏—Ç—Å—è –ø–æ—Ä—Ç —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—Ö–æ—Å—Ç;
- –∑–∞–ø—É—Å—Ç–∏—Ç—å nginx –Ω–∞ centralServer;
- –ø—Ä–æ–±—Ä–æ—Å–∏—Ç—å 80–π –ø–æ—Ä—Ç –Ω–∞ inetRouter2 8080;
- –¥–µ—Ñ–æ–ª—Ç –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –æ—Å—Ç–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ inetRouter.

–§–æ—Ä–º–∞—Ç —Å–¥–∞—á–∏ –î–ó - vagrant + ansible

# **–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**

–ó–¥–µ—Å—å:
- `readme.md` - –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è
- `VagrantFile` - —Ñ–∞–π–ª –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è `Vagrant`
- `roles\iptables` - —Ä–æ–ª—å –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω–∞—Ö

# **–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è ‚Ññ20**

–ó–∞–ø—É—Å—Ç–∏–º `Vagrantfile`.

Port knocking ‚Äî —ç—Ç–æ —Å–µ—Ç–µ–≤–æ–π –∑–∞—â–∏—Ç–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º, –¥–µ–π—Å—Ç–≤–∏–µ –∫–æ—Ç–æ—Ä–æ–≥–æ –æ—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–º –ø—Ä–∏–Ω—Ü–∏–ø–µ: 
—Å–µ—Ç–µ–≤–æ–π –ø–æ—Ä—Ç —è–≤–ª—è–µ—Ç—Å—è –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–∫—Ä—ã—Ç—ã–º, –Ω–æ –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –Ω–∞ –Ω–µ–≥–æ –Ω–µ –ø–æ—Å—Ç—É–ø–∏—Ç –∑–∞—Ä–∞–Ω–µ–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–∞—è 
–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–∞–∫–µ—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä–∞—è ¬´–∑–∞—Å—Ç–∞–≤–∏—Ç¬ª –ø–æ—Ä—Ç –æ—Ç–∫—Ä—ã—Ç—å—Å—è. 
–†–∞–±–æ—Ç–∞—è –≤ —Ä–µ–∂–∏–º–µ –¥–µ–º–æ–Ω–∞ —Å–æ–≤–º–µ—Å—Ç–Ω–æ —Å iptables, knockd –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–µ—Ç —Å–µ—Ç–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, 
–æ–∂–∏–¥–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ. –ö–∞–∫ —Ç–æ–ª—å–∫–æ knockd –æ—Ç–ª–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å, 
–æ–Ω –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—É, –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—É—é –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ knockd –¥–ª—è –¥–∞–Ω–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ‚Äî –∫–∞–∫ –ø—Ä–∞–≤–∏–ª–æ, —ç—Ç–æ –≤—ã–∑–æ–≤ 
iptables, —Ä–∞–∑—Ä–µ—à–∞—é—â–∏–π —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π —Å–µ—Ç–µ–≤–æ–π –ø–æ—Ä—Ç.

–¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è knockd:
```
[options]
        UseSyslog
        logfile = /var/log/knockd.log

[openSSH]
        sequence = 2222,3333,4444
        seq_timeout = 20
        command = /sbin/iptables -I INPUT 1 -s %IP% -p tcp --dport ssh -j ACCEPT
        tcpflags = syn
[closeSSH]
        sequence = 4444,3333,2222
        seq_timeout = 20
        command = /sbin/iptables -D INPUT -s %IP% -p tcp --dport 22 -j ACCEPT
        tcpflags = syn
```

- `sequence` : –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ—Ä—Ç–æ–≤, –∫ –∫–æ—Ç–æ—Ä—ã–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –∏–ª–∏ –∑–∞–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç 22. 
–ü–æ—Ä—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 2222, 3333, 4444, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –µ–≥–æ, –∏ 4444, 3333, 2222, —á—Ç–æ–±—ã –∑–∞–∫—Ä—ã—Ç—å. 
–í—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∏—Ö –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫ –¥—Ä—É–≥–∏–µ –ø–æ—Ä—Ç—ã. 

- `seq_timeout` : –ø–µ—Ä–∏–æ–¥ –≤—Ä–µ–º–µ–Ω–∏, –≤ —Ç–µ—á–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä–æ–≥–æ –∫—Ç–æ-—Ç–æ –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –ø–æ—Ä—Ç–∞–º, —á—Ç–æ–±—ã –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –æ—Ç–∫—Ä—ã—Ç–∏–µ –∏–ª–∏ –∑–∞–∫—Ä—ã—Ç–∏–µ.

- `command` : –ö–æ–º–∞–Ω–¥–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º–∞—è iptables –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –¥–µ–π—Å—Ç–≤–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∏–ª–∏ –∑–∞–∫—Ä—ã—Ç–∏—è. –≠—Ç–∏ –∫–æ–º–∞–Ω–¥—ã –ª–∏–±–æ –¥–æ–±–∞–≤–ª—è—é—Ç –ø—Ä–∞–≤–∏–ª–æ –∫ –±—Ä–∞–Ω–¥–º–∞—É—ç—Ä—É 
(—á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç), –ª–∏–±–æ –æ—Ç–º–µ–Ω—è—é—Ç –µ–≥–æ (—á—Ç–æ–±—ã –∑–∞–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç).

- `tcpflags` : —Ç–∏–ø –ø–∞–∫–µ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –∫–∞–∂–¥—ã–π –ø–æ—Ä—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å –≤ —Å–µ–∫—Ä–µ—Ç–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. 
–ü–∞–∫–µ—Ç SYN (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è) —è–≤–ª—è–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º –≤ –∑–∞–ø—Ä–æ—Å–µ TCP- —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç—Ä–µ—Ö—Å—Ç–æ—Ä–æ–Ω–Ω–∏–º —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–µ–º .

–í –∫–æ–º–ø–ª–µ–∫—Ç–µ —Å –¥–µ–º–æ–Ω–æ–º knockd –ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —É—Ç–∏–ª–∏—Ç–∞ knock, –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –æ—Å—É—â–µ—Å—Ç–≤–ª—è—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–µ—Ä–∏–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π.
–ß—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –¥–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞, –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–π—Ç–∏ –Ω–∞ `centralRouter` –∏ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ `inetRouter1`. –ü–æ—Å–ª–µ –Ω–µ—É–¥–∞—á–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è 
–ø–æ ssh, –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É `knock 192.168.255.1 2222 3333 4444`. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –≤ iptables –¥–æ–±–∞–≤–∏—Ç—å—Å—è –ø—Ä–∞–≤–∏–ª–æ, 
–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ –∏ –¥–æ—Å—Ç—É–ø –∫ `inetRouter1` –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã—Ç.

```
Last login: Wed Dec  8 13:32:42 2021 from 10.0.2.2
[vagrant@centralRouter ~]$ sudo su

[root@centralRouter vagrant]# ssh knock@192.168.255.1          
ssh: connect to host 192.168.255.1 port 22: Connection refused

[root@centralRouter vagrant]# knock 192.168.255.1 2222 3333 4444

[root@centralRouter vagrant]# ssh knock@192.168.255.1
The authenticity of host '192.168.255.1 (192.168.255.1)' can't be established.
ECDSA key fingerprint is SHA256:4CG/BTWqWxHm08OMeuT8gV5C3aIAfPmCwucOgEUqeGM.
ECDSA key fingerprint is MD5:fc:cc:a7:b3:29:37:66:31:60:4f:c6:53:97:6d:6e:40.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '192.168.255.1' (ECDSA) to the list of known hosts.
knock@192.168.255.1's password:

[knock@inetRouter1 ~]$ hostname
inetRouter1
```

***–£—Å—Ç–∞–Ω–æ–≤–∏–º –∏ –∑–∞–ø—É—Å—Ç–∏–º –Ω–∞ `centralServer` NGINX:***

```
[vagrant@centralServer ~]$ curl -I localhost
HTTP/1.1 200 OK
Server: nginx/1.20.1
Date: Wed, 08 Dec 2021 13:42:31 GMT
Content-Type: text/html
Content-Length: 4833
Last-Modified: Fri, 16 May 2014 15:12:48 GMT
Connection: keep-alive
ETag: "53762af0-12e1"
Accept-Ranges: bytes
``` 

–í `Vagrantfile` –¥–æ–±–∞–≤–∏–º –ø—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–æ–≤ —Å —Ö–æ—Å—Ç–∞ –Ω–∞ `inetRouter2`:
```
box.vm.network "forwarded_port", guest: 8080, guest_ip: "192.168.255.5", host: 9999, host_ip: "127.0.0.1",  protocol: "tcp"
```

–ù–∞ `inetRouter2` –≤ iptables –¥–æ–±–∞–≤–∏–º —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—è —Ç—Ä–∞—Ñ–∏–∫ —Å –ø–æ—Ä—Ç–∞ 8080 –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã `inetRouter2` 
–Ω–∞ 80 –ø–æ—Ä—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã `centerServer`:
```
    - iptables -t nat -A PREROUTING -p tcp -m tcp --dport 8080 -j DNAT --to-destination 192.168.0.10:80
    - iptables -t nat -A OUTPUT -p tcp --dport 8080 -j DNAT --to-destination 192.168.0.10:80
    - iptables -t nat -A POSTROUTING -j MASQUERADE
```

–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Ö–æ—Å—Ç–æ–≤–æ–π –º–∞—à–∏–Ω–µ –¥–æ—Å—Ç—É–ø –∫ NGINX –Ω–∞ `centralServer`:
```
user@user-B75H2-M3:~$ curl -I localhost:9999
HTTP/1.1 200 OK
Server: nginx/1.20.1
Date: Wed, 08 Dec 2021 13:45:05 GMT
Content-Type: text/html
Content-Length: 4833
Last-Modified: Fri, 16 May 2014 15:12:48 GMT
Connection: keep-alive
ETag: "53762af0-12e1"
Accept-Ranges: bytes
```

***–ü—Ä–æ–≤–µ—Ä–∏–º –º–∞—Ä—à—Ä—É—Ç –¥–æ—Å—Ç—É–ø–∞ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç:***

centralRouter:

```
[root@centralRouter vagrant]# traceroute ya.ru
traceroute to ya.ru (87.250.250.242), 30 hops max, 60 byte packets
 1  inetRouter1 (192.168.255.1)  5.111 ms  4.815 ms  4.687 ms
 2  * * *
 3  * * *
 4  ipoe-gw.ttk-chita.ru (188.168.81.1)  37.530 ms  37.369 ms  37.162 ms
 5  cta06rb.transtelecom.net (188.43.240.158)  37.094 ms  36.907 ms  36.724 ms
 6  mskn17.transtelecom.net (188.43.3.214)  128.183 ms  125.102 ms  124.911 ms
 7  Yandex-gw.transtelecom.net (188.43.3.213)  92.763 ms  110.832 ms  109.988 ms
 8  sas-32z3-ae2-1.yndx.net (87.250.239.185)  109.434 ms * sas-32z3-ae1-1.yndx.net (87.250.239.183)  140.379 ms
 9  ya.ru (87.250.250.242)  107.692 ms *  100.038 ms
```

centralServer:

```
[vagrant@centralServer ~]$ traceroute ya.ru
traceroute to ya.ru (87.250.250.242), 30 hops max, 60 byte packets
 1  centralRouter (192.168.0.1)  0.526 ms  0.376 ms  0.228 ms
 2  inetRouter1 (192.168.255.1)  2.824 ms  2.630 ms  2.446 ms
 3  * * *
 4  * * *
 5  * * *
 6  cta06rb.transtelecom.net (188.43.240.158)  55.003 ms  54.514 ms  54.132 ms
 7  mskn17.transtelecom.net (188.43.3.214)  163.795 ms  191.465 ms  163.260 ms
 8  Yandex-gw.transtelecom.net (188.43.3.213)  144.553 ms  90.122 ms  89.474 ms
 9  * sas-32z3-ae1-1.yndx.net (87.250.239.183)  126.544 ms sas-32z3-ae2-1.yndx.net (87.250.239.185)  126.100 ms
10  * * ya.ru (87.250.250.242)  106.448 ms
```

–°—Ö–µ–º–∞ —Å–µ—Ç–∏:

![Schema](https://github.com/MsyuLuch/LinuxProfessional/blob/main/homework-20/image.png)