# **Домашнее задание №8**

## **Bash**
 
Написать скрипт для крона, который раз в час присылает на заданную почту:
 
 - X IP адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта;
 - Y запрашиваемых адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта;
 - все ошибки c момента последнего запуска;
 - список всех кодов возврата с указанием их кол-ва с момента последнего запуска.
 В письме должно быть прописан обрабатываемый временной диапазон и должна быть реализована защита от мультизапуска.

# **Исходные данные**

Ссылка на проект https://github.com/MsyuLuch/LinuxProfessional/tree/main/homework-8

Здесь:
- `readme.md` - описание процесса выполнения домашнего задания
- `script_auto.sh` - скрипт для cron 
- `script_test.sh` - скрипт для тестирования

# **Описание процесса выполнения домашнего задания №8**

***Описание скрипта для cron***

Чтобы добавить скрипт на выполнение в cron, необходимо отредактировать файл /etc/crontab добавив строку:
```
0 */1 * * * /usr/bin/flock /var/tmp/myscript.lock /home/script_auto.sh > /dev/null 2>&1
```

`script_auto.sh` будет запускаться раз в час, выбирать информацию из log-файла, согласно параметрам заданным в начале скрипта.
В качестве защиты от мультизапуска используется программа flock. Эта команда запустит `/home/script_auto.sh` и создаст lock-файл для данного процесса. 
Пока он активен, новый вызов данного скрипта не произойдет. 

В результате работы скрипта будет сформирован текстовый файл mail.txt, который можно отправить на почту, например:
```
mail -s "cron mail" name@address.ext < $mailfile
```
Если на сервере настроена почта можно раскомментировать строку в скрипте. 

***Защита от повторного запуска***

В качестве защиты от мультизапуска можно использовать скрипт `lock.sh`, который при выполнении необходимого скрипта создает файл во временной директории. 
Когда скрипт завершится, он выполнит команду `rm -f $LOCKFILE` для удаления файла.

При возникновении сигнала будет выполнено указанное действие:
 
 `trap [action] [signal]`
 
Использование EXIT (0) вместо одного определенного сигнала (например, SIGINT - 2) гарантирует, что удаление произойдет при любом выходе. 
```
LOCKFILE=/tmp/lockfile

if [[ -f $LOCKFILE ]]
then
  echo "Lockfile exists, try again later..." >&2
  exit 1
fi
  echo "Process is running ( PID: $$ )" > $LOCKFILE
  trap 'rm -f $LOCKFILE' EXIT
 # do something...
```

***Тестирование скрипта***

Для тестирования скрипта можно запустить скрипт с параметрами:

1 - log-файл

2 - требуемое количество IP адресов (с наибольшим кол-вом запросов)

3 - требуемое количество запрашиваемых адресов (с наибольшим кол-вом запросов)

4 - необязательный параметр, если пустой, то выборка будет за последный час, если параметр задан, то выборка будет сформирована из всего файла, например, 

```
script_test.sh access.log 8 5 all

script_test.sh access.log 8 5
```
