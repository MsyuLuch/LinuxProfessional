# **–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ ‚Ññ17**

üîñ–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –¥–ª—è –∫—É—Ä—Å–∞ [Administrator Linux.Professional](https://otus.ru/lessons/linux-professional/)

## **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –±—ç–∫–∞–ø—ã**
 
–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å—Ç–µ–Ω–¥ Vagrant —Å –¥–≤—É–º—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º–∏ –º–∞—à–∏–Ω–∞–º–∏: backup_server –∏ client.

–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —É–¥–∞–ª–µ–Ω–Ω—ã–π –±–µ–∫–∞–ø –∫–∞—Ç–∞–ª–æ–≥–∞ /etc c —Å–µ—Ä–≤–µ—Ä–∞ client –ø—Ä–∏ –ø–æ–º–æ—â–∏ borgbackup. 
–†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º:

- –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π /var/backup. –≠—Ç–æ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. 
–í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ —Ä–∞–∑–º–µ—Ä –Ω–µ –ø—Ä–∏–Ω—Ü–∏–ø–∏–∞–ª–µ–Ω, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—É–¥–µ—Ç –∏ 2GB;
- —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω –∫–ª—é—á–æ–º –∏–ª–∏ –ø–∞—Ä–æ–ª–µ–º - –Ω–∞ –≤–∞—à–µ —É—Å–º–æ—Ç—Ä–µ–Ω–∏–µ;
- –∏–º—è –±–µ–∫–∞–ø–∞ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–µ–º–µ–Ω–∏ —Å–Ω—è—Ç–∏—è –±–µ–∫–∞–ø–∞;
- –≥–ª—É–±–∏–Ω–∞ –±–µ–∫–∞–ø–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≥–æ–¥, —Ö—Ä–∞–Ω–∏—Ç—å –º–æ–∂–Ω–æ –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–æ–ø–∏–∏ –Ω–∞ –∫–æ–Ω–µ—Ü –º–µ—Å—è—Ü–∞, –∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ç—Ä–µ—Ö. –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∏ –º–µ—Å—è—Ü–∞ –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–æ–ø–∏–∏ –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å. –¢.–µ. –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –ø–æ–ª–∏—Ç–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤;
- —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–Ω–∏–º–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç. –¢–∞–∫–æ–π —á–∞—Å—Ç—ã–π –∑–∞–ø—É—Å–∫ –≤ —Ü–µ–ª—è—Ö –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏;
- –Ω–∞–ø–∏—Å–∞–Ω —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–Ω—è—Ç–∏—è —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π. –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π Cron –¥–∂–æ–±—ã, –ª–∏–±–æ systemd timer-–∞ - –Ω–∞ –≤–∞—à–µ —É—Å–º–æ—Ç—Ä–µ–Ω–∏–µ;
- –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –±–µ–∫–∞–ø–∞. –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –º–æ–∂–Ω–æ –≤–µ—Å—å –≤—ã–≤–æ–¥ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –≤ logger —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º —Ç–µ–≥–æ–º. –ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç–µ –Ω–µ –≤ syslog, —Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞ —Ä–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤.

# **–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**

–ó–¥–µ—Å—å:
- `readme.md` - –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è
- `VagrantFile` - —Ñ–∞–π–ª –æ–ø–∏—Å—ã–≤–∞—é—â–∏–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è `Vagrant`
- `borg-backup.sh` - —Å–∫—Ä–∏–ø—Ç —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è

# **–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è ‚Ññ16**

Borg - Open Source-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö. –ü–ª—é—Å—ã:
1. –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è: —Ñ–∞–π–ª—ã –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ Borg repository (—Ç.–µ. —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–º –∫–∞—Ç–∞–ª–æ–≥–µ –≤ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ–º
–¥–ª—è Borg —Ñ–æ—Ä–º–∞—Ç–µ) –¥–µ–ª—è—Ç—Å—è –Ω–∞ –±–ª–æ–∫–∏ –ø–æ n –º–µ–≥–∞–±–∞–π—Ç, –∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –±–ª–æ–∫–∏ Borg –¥–µ–¥—É–ø–ª–∏—Ü–∏—Ä—É–µ—Ç. 
–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏–º–µ–Ω–Ω–æ –¥–æ —Å–∂–∞—Ç–∏—è.
2. –°–∂–∞—Ç–∏–µ: –ø–æ—Å–ª–µ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã–µ –µ—â—ë –∏ —Å–∂–∏–º–∞—é—Ç—Å—è. –î–æ—Å—Ç—É–ø–Ω—ã —Ä–∞–∑–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã —Å–∂–∞—Ç–∏—è: lz4, lzma, zlib, zstd. 
3. –†–∞–±–æ—Ç–∞ –ø–æ SSH: Borg –±—ç–∫–∞–ø–∏—Ç –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –ø–æ SSH. –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –ø–æ –∫–ª—é—á–∞–º.
4. –ì–∏–±–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –æ—Ç —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤.

–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:
```
yum install epel-release -y
yum install borgbackup -y
```

–ó–∞–ø—É—Å–∫–∞–µ–º Vagrantfile, –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –±—É–¥–µ—Ç –ø–æ–¥–Ω—è—Ç–æ 2 –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã: 
 - server (10.0.0.100) - —Å–µ—Ä–≤–µ—Ä —Å –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–µ–π /var/backup, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ—Å—É—â–µ—Å—Ç–≤–ª—è—Ç—å—Å—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
 ```
[root@server]# mount | grep backup
/dev/sdb1 on /var/backup type ext4 (rw,relatime,seclabel)
```
 - client (10.0.0.110) - –∫–ª–∏–µ–Ω—Ç, —Å –∫–æ—Ç–æ—Ä–æ–≥–æ —É–¥–∞–ª–µ–Ω–Ω–æ –±—É–¥–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ etc/

–ü–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –í–ú –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–π—Ç–∏ –Ω–∞ client –ø–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º `borg` (–ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–∞—Ä–æ–ª—å '123'),
—Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á –∏ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –µ–≥–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ–≥ –∑–∞—Ö–æ–¥–∏—Ç—å –±–µ–∑ –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è:
```
# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è borg
yes | ssh-keygen -b 2048 -t rsa -f /home/borg/.ssh/id_rsa -q -N ""
# –ö–æ–ø–∏—Ä—É–µ–º –∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è borg - 123)
ssh-copy-id -i borg@server
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –±–µ–∑ –ø–∞—Ä–æ–ª—è
ssh borg@server hostname

# –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —É–¥–∞–ª–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ /var/backup/client
# –∫–ª—é—á --encryption=repokey-blake2 - —Ä–µ–∂–∏–º —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
# —Ñ—Ä–∞–∑–∞, —à–∏—Ñ—Ä—É—é—â–∞—è –∞—Ä—Ö–∏–≤: "verylongandsecure" (–≤–Ω–µ—Å–µ–Ω–∞ –≤ —Å–∫—Ä–∏–ø—Ç borg-backup.sh)
borg init --encryption=repokey-blake2 borg@server:/var/backup/client
```

–°–∫—Ä–∏–ø—Ç —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è `borg-backup.sh` –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø–æ –∫—Ä–æ–Ω—É –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å
–∫–æ–ø–∏—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `/etc`, –ª–æ–≥ –ø—Ä–æ—Ü–µ—Å—Å–∞ –±—ç–∫–∞–ø–∞ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ `/var/log/borg-backup.log`:
```
# Example of job definition:
# .---------------- minute (0 - 59)
# |  .------------- hour (0 - 23)
# |  |  .---------- day of month (1 - 31)
# |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...
# |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat
# |  |  |  |  |
# *  *  *  *  * user-name  command to be executed

*/5  *  *  *  *  borg  /opt/borg-backup.sh >> /var/log/borg-backup.log
```
–î–ª—è —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤ –¥–æ–±–∞–≤–∏–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª `/etc/logrotate.d/borg-backup`:
```
/var/log/borg-backup.log {
missingok
notifempty
compress
size 100k
daily
create 0600 borg borg
}
```

–°–∫—Ä–∏–ø—Ç —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞–µ—Ç –∫–æ–ø–∏—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `/etc` –∏ —Å–ª–µ–¥–∏—Ç –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∫–æ–ø–∏–π:
```
# –£–¥–∞–ª–µ–Ω–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ —Ñ—Ä–∞–∑–∞ –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –∞—Ä—Ö–∏–≤–∞, —É–∫–∞–∑–∞–Ω–Ω–∞—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
export BORG_REPO=ssh://borg@server/var/backup/client
export BORG_PASSPHRASE='verylongandsecure'

# –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ /etc, —à–∞–±–ª–æ–Ω –∏–º–µ–Ω–∏ –∞—Ä—Ö–∏–≤–∞ {–∏–º—è —Ö–æ—Å—Ç–∞}-daily-{—Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è}
borg create \
  --verbose --filter AME \
  --list --stats --show-rc \
  --compression zlib,5 --exclude-caches \
  ::'{hostname}-daily-{now}' \
  /etc 2>&1

# –í —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –∞—Ä—Ö–∏–≤—ã –∑–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ —Ç–µ—á–µ–Ω–∏–∏ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 3 –º–µ—Å—è—Ü–µ–≤ 
# + –ø–æ 1 —Ñ–∞–π–ª—É –∑–∞ –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü –≤ —Ç–µ—á–µ–Ω–∏–∏ –≥–æ–¥–∞
borg prune \
    --list \
    --prefix '{hostname}-daily-' \
    --show-rc \
    --keep-daily 90 \
    --keep-monthly 12 2>&1
```

–ß—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∞—Ä—Ö–∏–≤–æ–≤:
```
[borg@client etc]$ borg list borg@server:/var/backup/client                                     
Enter passphrase for key ssh://borg@server/var/backup/client:
client-daily-2021-11-14T03:15:02     Sun, 2021-11-14 03:15:03 [83ffab1e77294d1c41219740683400088adbe2d53c5ab89c74244f37ce97]
```

–£–¥–∞–ª–∏–º –ª—é–±–æ–π —Ñ–∞–π–ª –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `/etc` –∏ –ø–æ–ø—Ä–æ–±—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –µ–≥–æ:
```
[borg@client ~]$ borg extract --list borg@server:/var/backup/client::client-daily-2021-11-14T03:15:02 etc/crontab
Enter passphrase for key ssh://borg@server/var/backup/client:
etc/crontab
```

